<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Neva Flow — v1.1.09</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --bg:#0f1115;--panel:#161a22;--field:#fff;
  --text:#e6e6e6;--muted:#9aa0a6;
  --accent:#c9a24d;--danger:#e74c3c;
  --success:#2ecc71;--rare:#6ab0ff;
}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",sans-serif}
html,body{margin:0;width:100%;height:100%;background:var(--bg);color:var(--text);padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
body{display:flex;flex-direction:column;align-items:center}
h1{margin:12px 0 6px;font-size:22px;color:var(--accent)}
#topBar{display:flex;gap:16px;font-size:14px;color:var(--muted);align-items:center}
#pauseBtn{margin-left:auto;background:none;border:none;color:var(--accent);font-size:18px;cursor:pointer}
#gameWrapper{width:100%;height:100%;padding:0;flex:1;display:flex;flex-direction:column}
#container{position:relative;flex:1;background:#000;border-radius:0;padding:0}
canvas{pointer-events:auto;width:100%;height:100%;background:#000;display:block}
.overlay{pointer-events:auto;position:absolute;inset:0;background:rgba(15,17,21,0.85);}
#start{background:rgba(15,17,21,1);display:flex;flex-direction:column;justify-content:center;align-items:center;gap:16px;text-align:center;z-index:20}
.overlay p{font-size:14px;color:var(--muted);line-height:1.5;max-width:320px}
button{border:none;background:var(--accent);color:#000;
  padding:10px 18px;border-radius:10px;font-size:14px;cursor:pointer}
</style>
</head>
<body>

<div id="topBar" style="position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:10;display:flex;gap:16px;font-size:14px;color:var(--muted);align-items:center;background:rgba(15,17,21,0.6);backdrop-filter:blur(6px);padding:8px 14px;border-radius:12px;">
  <div id="score">Очки: 5</div>
  <div id="level">Уровень: 1</div>
  <div id="combo">Комбо: 0</div>
  <button id="pauseBtn">⏸</button>
</div>

<div id="gameWrapper">
  <div id="container">
    <canvas id="game"></canvas>

    <!-- START -->
    <div id="start" class="overlay">
      <p>
        Двигайся влево и вправо.<br><br>
        Лови <b>жёлтые</b> шары — получай очки.<br>
        Избегай <b>красных</b> — они отнимают очки.<br><br>
        Если пропустишь жёлтый — потеряешь очко.<br>
        <b style="color:#6ab0ff">Синие</b> появляются редко,<br>
        но дают много очков.<br><br>
        Чем больше очков — тем быстрее игра.
      </p>
      <button id="playBtn" onclick="startGame();">\1</button>
    </div>

    <!-- PAUSE -->
    <div id="pause" class="overlay" style="display:none;">
      <p>
        Чем выше уровень — тем быстрее объекты.<br>
        Редкие бонусы появляются нечасто,<br>
        но сильно помогают.
      </p>
      <button onclick="togglePause()">Продолжить</button>
      <button onclick="startGame()">Заново</button>
    </div>

    <!-- OVER -->
    <div id="over" class="overlay" style="display:none;">
      <div id="stats"></div>
      <button onclick="startGame()">Сыграть ещё</button>
    </div>
</div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const container=document.getElementById("container");
function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize",resize);resize();

const isMobile=("ontouchstart" in window);

let player,enemies=[],bonuses=[],rares=[],effects=[];
let left=false,right=false,playing=false,paused=false;
let score=5,level=1,combo=0,tick=0;
let maxScore=5,maxLevel=1;

const scoreEl=document.getElementById("score");
const levelEl=document.getElementById("level");
const comboEl=document.getElementById("combo");
const pauseBtn=document.getElementById("pauseBtn");

function updateHUD(){
 if(score>maxScore) maxScore=score;
 if(level>maxLevel) maxLevel=level;
 scoreEl.textContent="Очки: "+score;
 levelEl.textContent="Уровень: "+level;
 comboEl.textContent="Комбо: "+combo;
}

function init(){
 const size=isMobile?48:40;
 player={x:canvas.width/2-size/2,y:canvas.height-70,
   w:size,h:size,speed:canvas.width/(isMobile?140:180)};
 enemies=[];bonuses=[];rares=[];effects=[];
 score=5;level=1;combo=0;tick=0;
 maxScore=score; maxLevel=level;
 updateHUD();
}

function levelUpEffect(){
  effects.push({
    x: canvas.width/2 - 60,
    y: canvas.height/2,
    text: 'Уровень ' + level,
    color: '#c9a24d',
    life: 120,
    static:true
  });
  if(navigator.vibrate) navigator.vibrate([20,30,20]);
}

function checkLevel(){
 const nl=Math.floor(score/20)+1;
 if(nl>level){ level=nl; levelUpEffect(); }
}

function vibrate(ms){
 if(navigator.vibrate) navigator.vibrate(ms);
}

function vibrate(ms){ if(navigator.vibrate) navigator.vibrate(ms); }

function addEffect(x,y,text,color){
 effects.push({x,y,text,color,life:40});
 if(text==='-1') vibrate(25);
 if(text==='+5') vibrate([15,20,15]);
 if(text==="-1") vibrate(30);
 if(text==="+5") vibrate([20,30,20]);
}

function startGame(){
  // iOS-safe fullscreen request from user action
  const el=document.documentElement;
  if(el.requestFullscreen) el.requestFullscreen();
  else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
 init();
 start.style.display="none";
 over.style.display="none";
 paused=false;playing=true;
 pause.style.display="none";
}
 startGame(); }, {passive:false});

function togglePause(){
 if(navigator.vibrate) navigator.vibrate(15);
 if(!playing)return;
 paused=!paused;
 pause.style.display=paused?"flex":"none";
}
pauseBtn.onclick=togglePause;

let touchStartX=null;
canvas.addEventListener("touchstart",e=>{
 e.preventDefault();
 touchStartX=e.touches[0].clientX;
});
canvas.addEventListener("touchmove",e=>{
 e.preventDefault();
 if(touchStartX===null)return;
 const dx=e.touches[0].clientX-touchStartX;
 player.x+=dx*0.6;
 touchStartX=e.touches[0].clientX;
});

document.addEventListener("keydown",e=>{
 if(e.key==="ArrowLeft")left=true;
 if(e.key==="ArrowRight")right=true;
 if(e.key==="Escape")togglePause();
});
document.addEventListener("keyup",e=>{
 if(e.key==="ArrowLeft")left=false;
 if(e.key==="ArrowRight")right=false;
});

function spawnEnemy(){
  const scale = Math.max(1, canvas.width/500);
 enemies.push({x:Math.random()*(canvas.width-40)+20,y:-30,r:18,
 speed:(canvas.height/260+level*0.4)/scale});
}
function spawnBonus(){
 bonuses.push({x:Math.random()*(canvas.width-40)+20,y:-30,r:12,
 speed:canvas.height/300+level*0.3});
}
function spawnRare(){
 rares.push({x:Math.random()*(canvas.width-50)+25,y:-40,r:16,
 speed:canvas.height/280});
}

function hit(a,b){
 return a.x<b.x+b.r&&a.x+a.w>b.x-b.r&&a.y<b.y+b.r&&a.y+a.h>b.y-b.r;
}

function loop(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 ctx.fillStyle="#fff";ctx.fillRect(0,0,canvas.width,canvas.height);

 if(playing&&!paused){
   if(!isMobile){
     if(left&&player.x>0)player.x-=player.speed;
     if(right&&player.x+player.w<canvas.width)player.x+=player.speed;
   }
   tick++;
   if(tick%Math.max(60-level*3,20)===0)spawnEnemy();
   if(tick%Math.max(90-level*4,30)===0)spawnBonus();
   if(tick%900===0)spawnRare();

   enemies.forEach(e=>e.y+=e.speed);
   bonuses.forEach(b=>b.y+=b.speed);
   rares.forEach(r=>r.y+=r.speed);

   enemies=enemies.filter(e=>{
     if(hit(player,e)){
       score--;combo=0;
       addEffect(e.x,e.y,"-1","#e74c3c");
       updateHUD(); if(score<=0)gameOver(); return false;
     }
     return e.y<canvas.height+40;
   });

   bonuses=bonuses.filter(b=>{
     if(hit(player,b)){
       score+=2;combo++;
       addEffect(b.x,b.y,"+2","#2ecc71");
       checkLevel();updateHUD();return false;
     }
     if(b.y>canvas.height){
       score--;combo=0;
       addEffect(b.x,canvas.height-20,"-1","#e74c3c");
       updateHUD(); if(score<=0)gameOver(); return false;
     }
     return true;
   });

   rares=rares.filter(r=>{
     if(hit(player,r)){
       score+=5;combo++;
       addEffect(r.x,r.y,"+5","#6ab0ff");
       checkLevel();updateHUD();return false;
     }
     if(r.y>canvas.height){
       score-=3;combo=0;
       addEffect(r.x,canvas.height-20,"-3","#6ab0ff");
       updateHUD(); if(score<=0)gameOver(); return false;
     }
     return true;
   });
 }

 ctx.fillStyle="#00bcd4";
 ctx.fillRect(player.x,player.y,player.w,player.h);

 enemies.forEach(e=>{
   ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
   ctx.fillStyle="#e74c3c";ctx.fill();
 });
 bonuses.forEach(b=>{
   ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
   ctx.fillStyle="#c9a24d";ctx.fill();
 });
 rares.forEach(r=>{
   ctx.beginPath();ctx.arc(r.x,r.y,r.r,0,Math.PI*2);
   ctx.fillStyle="#6ab0ff";ctx.fill();
 });

 effects=effects.filter(f=>{
   ctx.fillStyle=f.color;
   ctx.font="bold 18px sans-serif";
   if(!f.static){
     ctx.globalAlpha=f.life/40;
     ctx.fillText(f.text,f.x,f.y);
     f.y-=1;
   } else {
     ctx.globalAlpha=1;
     ctx.textAlign='center';
     ctx.fillText(f.text, canvas.width/2, canvas.height/2);
     ctx.textAlign='start';
   }
   ctx.globalAlpha=1;
   f.life--;
   return f.life>0;
 });

 requestAnimationFrame(loop);
}

function gameOver(){
  playing = false;
  over.style.display = "flex";
  stats.innerHTML = "Ты дошёл до уровня <b>" + level + "</b>, давай сыграем ещё?";
}

init();loop();

let fullscreenRequested=false;
function requestFullscreenOnce(){
  if(fullscreenRequested) return;
  fullscreenRequested=true;
  const el=document.documentElement;
  if(el.requestFullscreen) el.requestFullscreen();
  else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
}
document.addEventListener('click',requestFullscreenOnce,{once:true});

</script>
</body>
</html>
